# Video Attachments Implementation Plan

## Overview
Implement video attachments in Board cards supporting: (1) uploaded video files, (2) YouTube embeds, (3) Google Drive embeds.

## Reference Components to Study

### Primary Pattern: ImageElement
- **File:** `webapp/src/components/content/imageElement.tsx`
- Key patterns to follow:
  - `loadError` state for failed loads
  - Retry logic with `loadImage()`
  - Empty state when `src` is undefined
  - Fullscreen viewer on click (`openImageViewer()`)
  - CSS module for styling

### Supporting Reference Files

| File | Purpose |
|------|---------|
| `webapp/src/blocks/imageBlock.ts` | Block structure pattern, field definitions |
| `webapp/src/components/content/contentElement.tsx` | Registration pattern (switch statement) |
| `webapp/src/components/imageViewer/imageViewer.tsx` | Viewer pattern, modal handling |
| `webapp/src/components/blocksEditor/blocks/video/index.tsx` | Existing video block editor |
| `webapp/src/utils/utils.ts` | `Utils.selectLocalFile()`, `humanFileSize()` |
| `webapp/src/utils/flashMessages.tsx` | `sendFlashMessage()` for errors |
| `webapp/src/client/octoClient.ts` | API calls (`uploadFile()`, `getFileURL()`) |
| `webapp/src/utils/mutator.ts` | `createBlock()` pattern |

## Files to Create

### 1. `webapp/src/components/content/videoElement.tsx`
Main component for video card display.

**Structure (based on imageElement.tsx):**
```tsx
interface Props {
  block: VideoBlock;
  cardId: string;
  readonly: boolean;
}

export const VideoElement: React.FC<Props> = ({block, cardId, readonly}) => {
  const [loadError, setLoadError] = useState(false);
  const [thumbnailUrl, setThumbnailUrl] = useState<string>();

  // Detect source type from block fields
  const sourceType = block.sourceType || 'file'; // 'file' | 'youtube' | 'gdrive'

  // Render based on sourceType:
  // - file: thumbnail with play button overlay
  // - youtube: thumbnail from ytimg.com
  // - gdrive: placeholder with GDrive icon

  // Click handler opens VideoViewer

  // loadError state shows broken video icon
}
```

**Key responsibilities:**
- Parse `videoUrl` to extract `videoId` for YouTube/GDrive
- Display thumbnail preview
- Show play button overlay
- Handle click to open VideoViewer
- Handle loadError states
- i18n via `intl.formatMessage()`

### 2. `webapp/src/components/content/videoElement.scss`
Styling for video element (port from imageElement.scss):
- `.VideoElement` container
- `.thumbnail` with aspect ratio
- `.playButton` overlay
- `.loadError` state
- `.source-icon` for YouTube/GDrive

## Files to Modify

### 1. `webapp/src/blocks/videoBlock.ts`
Add fields for external video sources:

```typescript
export interface VideoBlock extends Block {
  sourceType?: 'file' | 'youtube' | 'gdrive';
  videoUrl?: string;      // Original YouTube/GDrive URL
  videoId?: string;       // Extracted ID
  thumbnailUrl?: string;  // Preview image
  fileId?: string;        // For uploaded files (existing)
}
```

### 2. `webapp/src/components/content/contentElement.tsx`
Register video element in the switch statement:

```tsx
import {VideoElement} from './videoElement';

// Inside CardContent component, switch statement:
case 'video':
  return <VideoElement block={block as VideoBlock} cardId={cardId} readonly={readonly} />;
```

### 3. `webapp/src/components/blocksEditor/blocks/video/index.tsx`
Enhance existing editor to:
- Detect YouTube/GDrive URLs on paste
- Parse URL to extract videoId
- Set appropriate sourceType
- Add URL input field for manual entry
- Show validation errors for invalid URLs

**URL Patterns:**
```typescript
// YouTube:
// - https://www.youtube.com/watch?v=VIDEO_ID
// - https://youtu.be/VIDEO_ID
// Extract: /(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/

// Google Drive:
// - https://drive.google.com/file/d/FILE_ID/view
// Extract: /drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/
```

### 4. `webapp/i18n/en.json`
Add video-related strings:

```json
{
  "VideoElement.loadError": "Failed to load video",
  "VideoElement.invalidUrl": "Invalid video URL",
  "VideoElementunsupportedSource": "Unsupported video source",
  "VideoElement.youtube": "YouTube",
  "VideoElement.gdrive": "Google Drive",
  "VideoElement.fileTooLarge": "Video file too large (max 500MB)",
  "VideoElement.unsupportedFormat": "Unsupported video format",
  "VideoViewer.title": "Video",
  "VideoViewer.openYouTube": "Open in YouTube",
  "VideoViewer.openGDrive": "Open in Google Drive"
}
```

### 5. `webapp/src/components/videoViewer/videoViewer.tsx` (Enhance existing)
Add support for YouTube/GDrive iframes:

```tsx
// Existing file viewer for file uploads
// Add:
// - YouTube iframe mode
// - Google Drive iframe mode
// - Platform-specific controls
// - "Open in [platform]" buttons

// YouTube embed URL: https://www.youtube.com/embed/VIDEO_ID
// GDrive preview URL: https://drive.google.com/file/d/VIDEO_ID/preview
```

## Implementation Approach

### Phase 1: Core VideoElement (File Uploads)
1. Create `videoElement.tsx` based on `imageElement.tsx`
2. Handle `sourceType === 'file'` with existing `fileId` field
3. Show thumbnail (first frame or default)
4. Click opens existing videoViewer
5. Add loadError handling

### Phase 2: YouTube Support
1. URL detection in video block editor
2. Parse videoId from YouTube URLs
3. Set `sourceType: 'youtube'`, `videoUrl`, `videoId`
4. Render thumbnail from `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`
5. VideoViewer loads YouTube iframe

### Phase 3: Google Drive Support
1. URL detection for drive.google.com URLs
2. Parse file ID from URL
3. Set `sourceType: 'gdrive'`
4. Render placeholder with GDrive icon
5. VideoViewer loads GDrive preview iframe

### Phase 4: UX Polish
1. Paste URL auto-detection in card editor
2. Invalid URL flash messages (don't create broken block)
3. Drag and drop video files (reuse Utils.selectLocalFile pattern)
4. Progress indicator for uploads
5. Mobile responsive styling

## Key Patterns to Follow

### 1. File Selection (from utils.ts)
```typescript
Utils.selectLocalFile(
  'video/*',  // Accept video files only
  (file) => {
    // Validate file size (< 500MB)
    // Upload via octoClient.uploadFile()
    // Create video block with fileId
  },
  {maxSize: 500 * 1024 * 1024}
)
```

### 2. Error Flash Messages
```typescript
import {sendFlashMessage} from '@/utils/flashMessages';

sendFlashMessage({
  content: intl.formatMessage({id: 'VideoElement.fileTooLarge'}),
  severity: 'error'
});
```

### 3. i18n Pattern
```typescript
import {FormattedMessage, useIntl} from 'react-intl';

const intl = useIntl();
intl.formatMessage({id: 'VideoElement.loadError'})

// Or component:
<FormattedMessage id='VideoElement.loadError' />
```

### 4. Load Error Pattern (from imageElement.tsx)
```tsx
const [loadError, setLoadError] = useState(false);

useEffect(() => {
  setLoadError(false);
}, [block.id]);

if (loadError) {
  return <div className='loadError'>Failed to load</div>;
}
```

### 5. Create Block Pattern (from mutator.ts)
```typescript
import {createBlock} from '@/utils/mutator';

const videoBlock = createVideoBlock(); // NOT {} as VideoBlock
videoBlock.sourceType = 'youtube';
videoBlock.videoId = extractedId;
// Add to card
```

## Edge Cases & Error Handling

| Scenario | Handling |
|----------|----------|
| Invalid URL format | Show flash message, do not create block |
| File too large (>500MB) | Show flash message with max size |
| Unsupported video format | Show flash message with supported formats |
| HEVC video from mobile | Browser support varies, allow upload, show error on play |
| Network error during upload | Retry button in upload progress |
| User cancels upload | Remove block, don't leave broken state |
| YouTube video private/unavailable | Show loadError state, link to YouTube |
| GDrive link not publicly shared | Show loadError with instructions |
| Thumbnail generation fails | Use default thumbnail or play button on solid background |

## Testing Strategy

### Snapshot Tests
Create `webapp/src/components/content/videoElement.test.tsx`:
1. Test render for file upload
2. Test render for YouTube URL
3. Test render for GDrive URL
4. Test loadError state

### Manual Testing Checklist
- [ ] Upload mp4 file (< 500MB)
- [ ] Upload webm file
- [ ] Upload mov/HEVC from mobile
- [ ] Try upload > 500MB (should error)
- [ ] Paste YouTube watch URL
- [ ] Paste youtu.be short URL
- [ ] Paste GDrive file URL
- [ ] Paste invalid URL (should flash, not create block)
- [ ] Click video thumbnail opens fullscreen
- [ ] YouTube video plays in iframe
- [ ] GDrive preview loads
- [ ] Cancel upload (no broken block)
- [ ] Mobile responsive
- [ ] Keyboard navigation (Esc to close viewer)

## Migration Notes

**Backward compatibility:** Existing video blocks with only `fileId` will default to `sourceType: 'file'`. No migration needed.

## Dependencies

**External APIs:**
- YouTube thumbnails: Public URL `https://img.youtube.com/vi/${id}/hqdefault.jpg`
- GDrive preview: Public preview URL works if file has "anyone with link" sharing

**No server changes required** for Phase 1-3. All URL handling client-side.

Thumbnail generation API (future enhancement) would require backend ffmpeg support.

## Implementation Order

1. **Create videoElement.tsx** - file uploads only
2. **Modify contentElement.tsx** - register video element
3. **Enhance video block editor** - URL detection
4. **Enhance videoViewer.tsx** - iframe support
5. **Add i18n strings**
6. **Add snapshot tests**
7. **Manual testing**

## Notes

- Follow existing code style (functional components, hooks, TypeScript)
- Reuse existing utilities (Utils, octoClient, mutator)
- Match imageElement patterns for consistency
- No container changes needed initially
- HEVC support depends on browser; Chrome supports, Safari supports, Firefox requires codec
